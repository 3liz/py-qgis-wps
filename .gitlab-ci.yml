stages:
- test
- build
- docker
- deploy
- release

#-----------------
# Tests
#-----------------

.tests:
  image: ${REGISTRY_URL}/factory-ci-runner:qgis-${QGIS_FLAVOR}
  services:
    - name: ${REGISTRY_URL}/redis:7-alpine
      alias: redis
  stage: test
  script:
    - source ~/.bashrc
    - make install install-tests
    - pip list -l
    - make test FLAVOR=$QGIS_FLAVOR
  tags:
    - infrav3-dind

tests:ltr:
  extends: .tests
  variables:
    QGIS_FLAVOR: ltr

tests:release:
  extends: .tests
  needs:
    - "tests:ltr"
  variables:
    QGIS_FLAVOR: release

tests:3.28:
  extends: .tests
  needs:
    - "tests:release"
  variables:
    QGIS_FLAVOR: "3.28"


# Docker build 
include: '/docker/.gitlab-ci.yml'

